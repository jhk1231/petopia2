<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org">

<div id="layoutSidenav_content">
	<main>
		<div class="container-fluid px-4">

			<div class="row mt-3 mb-5">
				<div class="inner">
					<h3>게시글 세부 조회</h3>
					<div>
						<h1>
							<input type="hidden" id="article_no" th:value="${article.no}">
							<input type="hidden" id="board_no" th:value="${article.boardNo}">
						</h1>
						<form id="detailContent" th:object="${article}" name="article">
							<table width=100%>
								<colgroup>
									<col width="15%">
									<col width="35%">
									<col width="15%">
									<col width="*">
								</colgroup>
								<tbody>
									<tr>
										<th>제목</th>
										<td th:text="${article.subject}" th:field="*{subject}"></td>
										<th>조회수</th>
										<td th:text="${article.viewcount}" th:field="*{viewcount}"></td>
									</tr>
									<tr>
										<th>작성자</th>
										<td th:text="${article.nickname}" th:field="*{nickname}"></td>
										<th>작성일</th>
										<td th:text="${article.writeDate}"></td>
									</tr>
									<tr>
										<th>내용</th>
										<td th:text="${article.content}" th:field="*{content}"></td>
									</tr>
									<tr>
										<th>첨부파일</th>
										<td th:if="${article.attacheFile == null}">첨부된 파일이 없습니다.</td>
										<td th:unless="${article.attacheFile == null}"><a
											th:href="|/attach/${article.getAttacheFile().getNo()}|"
											th:text="${article.getAttacheFile().getSystemFileName()}|"></a>
										</td>
									</tr>
									<tr th:if="${article.fileList != null}">
										<td>
											<!--이미지 파일들--> 
											<img th:each="imageFile : ${article.fileList}" th:src="|/images/${imageFile.getSystemFileName()}|"
											width="200" height="200" />
										</td>
									</tr>
									<tr>
										<div style="display: inline;">
											<td colspan="2"><input type="button"
												th:onclick="|location.href='@{/writeArticleForm}'|"
												value="글쓰기" /> <input type="button"
												th:onclick="|location.href='@{/nListArticle/{boardNo}(boardNo=${article.boardNo})}'|"
												value="목록" /> <input type="button" id="rec_update"
												value="추천" /><!--  <strong><input type="text"
													id="like_num" value=""></strong> --></td>
										</div>

										<!--본인만 가능-->
										<div style="float: right;">
											<td><input type="button"
												th:onclick="|location.href='@{/updateArticleForm/{articleNo}(articleNo=${article.no})}'|"
												value="수정" /> <input type="button" id="remove_article_btn"
												value="삭제" /></td>
										</div>
									</tr>

								</tbody>
							</table>
						</form>
					</div>
					<!-- 댓글 -->

					<div id="writeReplyForm">
						<textarea id="write_content" name="write_content" rwos="5"
							cols="50" placeholder="댓글을 입력해주세요."></textarea>
						<button type="button" id="write_reply_btn">등록</button>
					</div>

					<div id="replys">
						<div class="reply_list"
							th:each="reply : ${article.getReplyList()}">
							<table th:id="${reply.getNo()}">
								<tbody>
									<tr>
										<td class="Content" th:text="${reply.content}"></td>
									</tr>
									<tr>
										<td th:text="${reply.nickname}"></td>
									</tr>
									<tr>
										<td th:text="${reply.writeDate}"></td>
									</tr>
								</tbody>
								<tfoot>
									<tr>
										<td><input type="button" class="modify_Reply_Form_Btn"
											value="수정" /> <input type="button" class="remove_Reply_Btn"
											value="삭제" /></td>
									</tr>
								</tfoot>
							</table>
						</div>
					</div>
					<!-- 수정 폼 -->
					<div id="modify_reply_form" style="display: none;">
						<div id="writeReplyForm">
							<input type="hidden" id="no" />
							<textarea id="reply_content" rwos="5" cols="50" placeholder=""></textarea>
							<button class="modify_cancle">취소</button>
							<button class="modify_reply_btn">수정</button>
						</div>
					</div>

				</div>
			</div>
		</div>
	</main>
</div>
<script th:src="@{../js/jquery-3.6.0.min.js}"></script>
<script>
	$(document).ready(function () {
	
		$('#remove_article_btn').on('click',function(){
			const boardNo = $("#board_no").val();
			const articleNo = $("#article_no").val();
			location.href='/removeArticle/' +   articleNo + '/' + boardNo; 
		})
		/* // 추천 버튼 클릭시
		$('#rec_update').click(function () {
			$.ajax({
				url: "/RecUpdate",
				type: "POST",
				data: {
					// 게시글을 추천 했는지 안했는지 확인.
					articleNo: $("#article_no").val(),
					memberNo: '${sessionScope.user.no }'
				},
				success: function (count) {
					$("#rec_count").val(JSON.parse(count).totalCount);					
					// $("#rec_count").html(JSON.parse(count).totalCount);
					//recCount();
				},
			})
		})

		// 게시글 추천수
		function recCount() {
			$.ajax({
				url: "/RecCount.do",
				type: "POST",
				data: {
					// 게시글의 총 추천수만 구하면 되니 게시글 번호만 넘겨준다.
					articleNo: $("#article_no").val()
				},
				success: function (count) {
					// rec_count 내용을 비우고 count로 갱신
					$("#rec_count").val(JSON.parse(count).totalCount);
					$(".rec_count").html(JSON.parse(count).totalCount); 
				},
			})
			// 맨처음 시작시 호출
		// recCount();
		}; 
		*/
		


		/*-------------------댓글 ------------------ */
		const getAjax = function (url, no, content) {
			// resolve, reject는 자바스크립트에서 지원하는 콜백 함수이다.
			return new Promise((resolve, reject) => {
				$.ajax({
					url: url,
					method: 'POST',
					dataType: 'json',
					data: {
						no: no,
						content: content,
						articleNo: $("#article_no").val()

					},
					success: function (data) {
						resolve(data);
					},
					error: function (e) {
						reject(e);
					}
				});
			});
		}

		const removeReply = function (url, no) {
			// resolve, reject는 자바스크립트에서 지원하는 콜백 함수이다.
			return new Promise((resolve, reject) => {
				$.ajax({
					url: url,
					method: 'GET',
					dataType: 'json',
					data: {
						no: no,
						articleNo: $("#article_no").val()
					},
					success: function (data) {
						resolve(data);
					},
					error: function (e) {
						console.trace();
						reject(e);
					}
				});
			});
		}

		async function requestProcess(url, no, content) {
			try {
				console.log("rP 접속");
				let replyList = null;
				if (content == null || content == '' || typeof content == "undefined") {
					replyList = await removeReply(url, no);
				} else {
					console.log("GetAjAx 전");
					replyList = await getAjax(url, no, content);
					console.log("GetAjAx 후");
				}

				$('#replys').html("");
				let htmlStr = [];

				console.log(htmlStr);
				for (let i = 0; i < replyList.length; i++) {
					htmlStr.push('<div class="reply_list">');
					htmlStr.push('<table id=' + replyList[i].no + '>');
					htmlStr.push('<tbody>');
					htmlStr.push('<tr>');
					htmlStr.push('<td class="Content">' + replyList[i].content + "</td>");
					htmlStr.push('<tr>');
					htmlStr.push('<td>' + replyList[i].nickname + "</td>");
					htmlStr.push('</tr>');
					htmlStr.push('<tr>');
					htmlStr.push('<td>' + replyList[i].writeDate + "</td>");
					htmlStr.push('</tr>');
					htmlStr.push('</tbody>');
					htmlStr.push('<tfoot>');
					htmlStr.push('<tr>');
					htmlStr.push('<td><input type="button" class="modify_Reply_Form_Btn" value="수정" />&nbsp;');
					htmlStr.push('<input type="button" class="remove_Reply_Btn" value="삭제" /></td>');
					htmlStr.push('</tr>');
					htmlStr.push('</tfoot>');
					htmlStr.push('</table>');
					htmlStr.push('</div>');
				}
				console.log(htmlStr);
				$('#replys').html(htmlStr.join(""));

			} catch (error) {
				console.trace();
				console.log("error : ", error);
			}
		}

		console.log();

		//댓글 작성
		$('#write_reply_btn').on('click', function () {
			const articleNo = $("#article_no").val();
			const content = $('#write_content').val();
			console.log('ajax전');
			requestProcess('/insertReply', articleNo, content);
			$("#write_content").val(""); // textarea 비우기
			console.log('ajax후');
		});


		//댓글 수정폼
		$(document).on('click', '.modify_Reply_Form_Btn', function () {
			const no = $(this).parents('table').attr('id');
			$('#modify_reply_form').insertAfter('#' + no);
			const content = $('#' + no).find('.Content').text();
			console.log('content:', content);
			$('#reply_content[placeholder]').val(content);
			$('#no').val(no);
			$('#modify_reply_form').show();
			$('#' + no).hide();
		});


		//댓글 수정폼 닫기
		$('.modify_cancle').on('click', function () {
			const no = $('#no').val();
			console.log('cancelModifyFormNo:', no);
			$('#' + no).show();
			$('#modify_reply_form').hide();
			$('#modify_reply_form').insertAfter('#writeReplyForm');
		});

		//댓글 수정
		$('.modify_reply_btn').on('click', function () {
			// 댓글No
			const no = $('#no').val();
			console.log('modifyActionNo:', no);
			const content = $('#' + no).parent('div').find('#reply_content').val();
			console.log('modifyReplyContent:', content);
			requestProcess('/modifyReply', no, content);
			$('#modify_reply_form').insertAfter('#writeReplyForm');
			$('#modify_reply_form').hide();
			$('#modify_reply_form').html();
		});


		//댓글 삭제
		$(document).on('click', '.remove_Reply_Btn', function () {
			const no = $(this).parents('table').attr('id');
			console.log('remove', no)
			requestProcess('/removeReply', no);
		});






	});
</script>


</html>